!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).ReactDnDTouchBackend={})}(this,(function(e){"use strict";var t;!function(e){e.mouse="mouse",e.touch="touch",e.keyboard="keyboard"}(t||(t={}));var n=1,o=0;function i(e){return void 0===e.button||e.button===o}function r(e){return!!e.targetTouches}function s(e,t){return r(e)?function(e,t){return 1===e.targetTouches.length?s(e.targetTouches[0]):t&&1===e.touches.length&&e.touches[0].target===t.target?s(e.touches[0]):void 0}(e,t):{x:e.clientX,y:e.clientY}}function a(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var u,d=function(){function e(t,n){var o=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.enableTouchEvents=!0,this.enableMouseEvents=!1,this.enableKeyboardEvents=!1,this.ignoreContextMenu=!1,this.enableHoverOutsideTarget=!1,this.touchSlop=0,this.scrollAngleRanges=void 0,this.context=n,this.delayTouchStart=t.delayTouchStart||t.delay||0,this.delayMouseStart=t.delayMouseStart||t.delay||0,Object.keys(t).forEach((function(e){null!=t[e]&&(o[e]=t[e])}))}var t,n,o;return t=e,(n=[{key:"window",get:function(){return this.context&&this.context.window?this.context.window:"undefined"!=typeof window?window:void 0}},{key:"document",get:function(){if(this.window)return this.window.document}}])&&a(t.prototype,n),o&&a(t,o),e}();function c(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=(h(u={},t.mouse,{start:"mousedown",move:"mousemove",end:"mouseup",contextmenu:"contextmenu"}),h(u,t.touch,{start:"touchstart",move:"touchmove",end:"touchend"}),h(u,t.keyboard,{keydown:"keydown"}),u),v=function(){function e(o,a,u){var c=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.getSourceClientOffset=function(e){var t=c.sourceNodes.get(e);return t&&function(e){var t=1===e.nodeType?e:e.parentElement;if(t){var n=t.getBoundingClientRect(),o=n.top;return{x:n.left,y:o}}}(t)},this.handleTopMoveStartCapture=function(e){i(e)&&(c.moveStartSourceIds=[])},this.handleMoveStart=function(e){Array.isArray(c.moveStartSourceIds)&&c.moveStartSourceIds.unshift(e)},this.handleTopMoveStart=function(e){if(i(e)){var t=s(e);t&&(r(e)&&(c.lastTargetTouchFallback=e.targetTouches[0]),c._mouseClientOffset=t),c.waitingForDelay=!1}},this.handleTopMoveStartDelay=function(e){if(i(e)){var t=e.type===l.touch.start?c.options.delayTouchStart:c.options.delayMouseStart;c.timeout=setTimeout(c.handleTopMoveStart.bind(c,e),t),c.waitingForDelay=!0}},this.handleTopMoveCapture=function(){c.dragOverTargetIds=[]},this.handleMove=function(e,t){c.dragOverTargetIds&&c.dragOverTargetIds.unshift(t)},this.handleTopMove=function(e){if(c.timeout&&clearTimeout(c.timeout),c.document&&!c.waitingForDelay){var t,n,o,i,r=c.moveStartSourceIds,a=c.dragOverTargetIds,u=c.options.enableHoverOutsideTarget,d=s(e,c.lastTargetTouchFallback);if(d)if(c._isScrolling||!c.monitor.isDragging()&&function(e,t,n,o,i){if(!i)return!1;for(var r=180*Math.atan2(o-t,n-e)/Math.PI+180,s=0;s<i.length;++s)if((null==i[s].start||r>=i[s].start)&&(null==i[s].end||r<=i[s].end))return!0;return!1}(c._mouseClientOffset.x||0,c._mouseClientOffset.y||0,d.x,d.y,c.options.scrollAngleRanges))c._isScrolling=!0;else if(!c.monitor.isDragging()&&c._mouseClientOffset.hasOwnProperty("x")&&r&&(t=c._mouseClientOffset.x||0,n=c._mouseClientOffset.y||0,o=d.x,i=d.y,Math.sqrt(Math.pow(Math.abs(o-t),2)+Math.pow(Math.abs(i-n),2))>(c.options.touchSlop?c.options.touchSlop:0))&&(c.moveStartSourceIds=void 0,c.actions.beginDrag(r,{clientOffset:c._mouseClientOffset,getSourceClientOffset:c.getSourceClientOffset,publishSource:!1})),c.monitor.isDragging()){var h=c.sourceNodes.get(c.monitor.getSourceId());c.installSourceNodeRemovalObserver(h),c.actions.publishDragSource(),e.cancelable&&e.preventDefault();var l=(a||[]).map((function(e){return c.targetNodes.get(e)})).filter((function(e){return!!e})),v=c.options.getDropTargetElementsAtPoint?c.options.getDropTargetElementsAtPoint(d.x,d.y,l):c.document.elementsFromPoint(d.x,d.y),f=[];for(var p in v)if(v.hasOwnProperty(p)){var g=v[p];for(f.push(g);g;)(g=g.parentElement)&&-1===f.indexOf(g)&&f.push(g)}var m=f.filter((function(e){return l.indexOf(e)>-1})).map((function(e){return c._getDropTargetId(e)})).filter((function(e){return!!e})).filter((function(e,t,n){return n.indexOf(e)===t}));if(u)for(var w in c.targetNodes){var y=c.targetNodes.get(w);if(h&&y&&y.contains(h)&&-1===m.indexOf(w)){m.unshift(w);break}}m.reverse(),c.actions.hover(m,{clientOffset:d})}}},this._getDropTargetId=function(e){for(var t=c.targetNodes.keys(),n=t.next();!1===n.done;){var o=n.value;if(e===c.targetNodes.get(o))return o;n=t.next()}},this.handleTopMoveEndCapture=function(e){c._isScrolling=!1,c.lastTargetTouchFallback=void 0,function(e){return void 0===e.buttons||0==(e.buttons&n)}(e)&&(c.monitor.isDragging()&&!c.monitor.didDrop()?(e.cancelable&&e.preventDefault(),c._mouseClientOffset={},c.uninstallSourceNodeRemovalObserver(),c.actions.drop(),c.actions.endDrag()):c.moveStartSourceIds=void 0)},this.handleCancelOnEscape=function(e){"Escape"===e.key&&c.monitor.isDragging()&&(c._mouseClientOffset={},c.uninstallSourceNodeRemovalObserver(),c.actions.endDrag())},this.options=new d(u,a),this.actions=o.getActions(),this.monitor=o.getMonitor(),this.sourceNodes=new Map,this.sourcePreviewNodes=new Map,this.sourcePreviewNodeOptions=new Map,this.targetNodes=new Map,this.listenerTypes=[],this._mouseClientOffset={},this._isScrolling=!1,this.options.enableMouseEvents&&this.listenerTypes.push(t.mouse),this.options.enableTouchEvents&&this.listenerTypes.push(t.touch),this.options.enableKeyboardEvents&&this.listenerTypes.push(t.keyboard)}var o,a,u;return o=e,(a=[{key:"profile",value:function(){var e;return{sourceNodes:this.sourceNodes.size,sourcePreviewNodes:this.sourcePreviewNodes.size,sourcePreviewNodeOptions:this.sourcePreviewNodeOptions.size,targetNodes:this.targetNodes.size,dragOverTargetIds:(null===(e=this.dragOverTargetIds)||void 0===e?void 0:e.length)||0}}},{key:"setup",value:function(){this.window&&(function(e,t){for(var n=arguments.length,o=new Array(n>2?n-2:0),i=2;i<n;i++)o[i-2]=arguments[i];if(!e){var r;if(void 0===t)r=new Error("Minified exception occurred; use the non-minified dev environment for the full error message and additional helpful warnings.");else{var s=0;(r=new Error(t.replace(/%s/g,(function(){return o[s++]})))).name="Invariant Violation"}throw r.framesToPop=1,r}}(!e.isSetUp,"Cannot have two Touch backends at the same time."),e.isSetUp=!0,this.addEventListener(this.window,"start",this.getTopMoveStartHandler()),this.addEventListener(this.window,"start",this.handleTopMoveStartCapture,!0),this.addEventListener(this.window,"move",this.handleTopMove),this.addEventListener(this.window,"move",this.handleTopMoveCapture,!0),this.addEventListener(this.window,"end",this.handleTopMoveEndCapture,!0),this.options.enableMouseEvents&&!this.options.ignoreContextMenu&&this.addEventListener(this.window,"contextmenu",this.handleTopMoveEndCapture),this.options.enableKeyboardEvents&&this.addEventListener(this.window,"keydown",this.handleCancelOnEscape,!0))}},{key:"teardown",value:function(){this.window&&(e.isSetUp=!1,this._mouseClientOffset={},this.removeEventListener(this.window,"start",this.handleTopMoveStartCapture,!0),this.removeEventListener(this.window,"start",this.handleTopMoveStart),this.removeEventListener(this.window,"move",this.handleTopMoveCapture,!0),this.removeEventListener(this.window,"move",this.handleTopMove),this.removeEventListener(this.window,"end",this.handleTopMoveEndCapture,!0),this.options.enableMouseEvents&&!this.options.ignoreContextMenu&&this.removeEventListener(this.window,"contextmenu",this.handleTopMoveEndCapture),this.options.enableKeyboardEvents&&this.removeEventListener(this.window,"keydown",this.handleCancelOnEscape,!0),this.uninstallSourceNodeRemovalObserver())}},{key:"addEventListener",value:function(e,t,n,o){var i=o;this.listenerTypes.forEach((function(o){var r=l[o][t];r&&e.addEventListener(r,n,i)}))}},{key:"removeEventListener",value:function(e,t,n,o){var i=o;this.listenerTypes.forEach((function(o){var r=l[o][t];r&&e.removeEventListener(r,n,i)}))}},{key:"connectDragSource",value:function(e,t){var n=this,o=this.handleMoveStart.bind(this,e);return this.sourceNodes.set(e,t),this.addEventListener(t,"start",o),function(){n.sourceNodes.delete(e),n.removeEventListener(t,"start",o)}}},{key:"connectDragPreview",value:function(e,t,n){var o=this;return this.sourcePreviewNodeOptions.set(e,n),this.sourcePreviewNodes.set(e,t),function(){o.sourcePreviewNodes.delete(e),o.sourcePreviewNodeOptions.delete(e)}}},{key:"connectDropTarget",value:function(e,t){var n=this;if(!this.document)return function(){};var o=function(o){if(n.document&&n.monitor.isDragging()){var i;switch(o.type){case l.mouse.move:i={x:o.clientX,y:o.clientY};break;case l.touch.move:i={x:o.touches[0].clientX,y:o.touches[0].clientY}}var r=null!=i?n.document.elementFromPoint(i.x,i.y):void 0,s=r&&t.contains(r);return r===t||s?n.handleMove(o,e):void 0}};return this.addEventListener(this.document.body,"move",o),this.targetNodes.set(e,t),function(){n.document&&(n.targetNodes.delete(e),n.removeEventListener(n.document.body,"move",o))}}},{key:"getTopMoveStartHandler",value:function(){return this.options.delayTouchStart||this.options.delayMouseStart?this.handleTopMoveStartDelay:this.handleTopMoveStart}},{key:"installSourceNodeRemovalObserver",value:function(e){var t=this;this.uninstallSourceNodeRemovalObserver(),this.draggedSourceNode=e,this.draggedSourceNodeRemovalObserver=new MutationObserver((function(){e&&!e.parentElement&&(t.resurrectSourceNode(),t.uninstallSourceNodeRemovalObserver())})),e&&e.parentElement&&this.draggedSourceNodeRemovalObserver.observe(e.parentElement,{childList:!0})}},{key:"resurrectSourceNode",value:function(){this.document&&this.draggedSourceNode&&(this.draggedSourceNode.style.display="none",this.draggedSourceNode.removeAttribute("data-reactid"),this.document.body.appendChild(this.draggedSourceNode))}},{key:"uninstallSourceNodeRemovalObserver",value:function(){this.draggedSourceNodeRemovalObserver&&this.draggedSourceNodeRemovalObserver.disconnect(),this.draggedSourceNodeRemovalObserver=void 0,this.draggedSourceNode=void 0}},{key:"window",get:function(){return this.options.window}},{key:"document",get:function(){if(this.window)return this.window.document}}])&&c(o.prototype,a),u&&c(o,u),e}();e.TouchBackend=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return new v(e,t,n)},e.TouchBackendImpl=v,Object.defineProperty(e,"__esModule",{value:!0})}));
